//Code to verify one point on the modular curve S_4(13)
//with j-invariant -160855552000/1594323


//   Coordinate number 0:
map_0_coord_0 := 1*(-1340680643166949351907313105871689604483436733166646431059931777085973048041649496727620312*x^3*y^21+187126515775450112687784175804089486005735789576546292081237691745031635214298165670136008*x^2*y^22-644146491753257527591070278452662947681451090026844863304003665172447545575103160300604648*x*y^23+17617313240663356575261670048870317782662461202058028263989637443839430236816406250000*y^24+41207927690768840754605164596660340526200777404801721475204165076716905782112634113758461932*x^3*y^20*z-44504266836046786774188981646800712460491680966343069848249761168788488328191339136486435208*x^2*y^21*z+20544230004749416365649682589814182514442522639853247212321894274945232160155320232981119944*x*y^22*z-1609596248621847399820312424544692655339892968146804615626921407010017863282545498407761620*y^23*z-438204469573672004771331669380458657734193287342694469719019289946034263766423004395137476029*x^3*y^19*z^2+749676031592764166407999924256150691836193473217251235788175731923048198098901000882166112930*x^2*y^20*z^2-438318856327029511476688835818792517152157589972588860512077607062913755885353352330350360278*x*y^21*z^2+42242722159388246021133157925661281208859538575646147645373421886243332526707387916321811041*y^22*z^2+2615667935987940681414638684981643583793328611088257021849416179150139450480805938958248865649*x^3*y^18*z^3-5561328905332206570044118858899061101653244377442602263830053362985186726729248474453392788524*x^2*y^19*z^3+4183016881984666169404645981048476977570387191449896827397801157213733881049600660595090889397*x*y^20*z^3-688902831292890897450304736071937714585248578603666734905785712988162153351422302947821738705*y^21*z^3-7623927132145287329794421754412004667923103658768273655790317957131695346827289037995259312449*x^3*y^17*z^4+19669417098251660541695240014131922634001569470262751505613724312216666488203484286231532581337*x^2*y^18*z^4-18280822811549621113733356924281144334870687244798397384156633432685993944077169431022970837771*x*y^19*z^4+4888442347578350219455813805581790665118625737791212156953856849727760480475113191233805355970*y^20*z^4+3817157729146004444491756658447356207647502783176554534311092966362566187244384545861433935091*x^3*y^16*z^5-22514869407689013951994426695310680056523442619057560842039218077155137084242783376764357955168*x^2*y^17*z^5+30353774751985585202538607348330447482316604461639103171213258402596466231019392846580457025770*x*y^18*z^5-13821273629405618308389826803426081823337835180459529241304613071981189135112546494407265412633*y^19*z^5+19545292292727648685981795850693889644447973173398059630397244314447304206452202045303469707879*x^3*y^15*z^6-29727297529976424162287800714814807211261165106698939979223194030191349573124588901557534505524*x^2*y^16*z^6+11669975855448042053904069607591188460935870484132640537736497959182761434007070880994306762153*x*y^17*z^6+6317383176386937689201930105647558602591887467515634732158231349581394107791889765406716983866*y^18*z^6-17951380890816908629182404152242709898580033133312245057876821155179228204928857483381292172887*x^3*y^14*z^7+63597336351007744673859256065637668586407393727184019588194257058834980410479939441489123259914*x^2*y^15*z^7-66154840610467169926122110543073282157070022381937483156379806468820204616457894676672786428113*x*y^16*z^7+24785127996054268016013593298737879642937021815122939468140537173815475563814539338977245959925*y^17*z^7+12158716035794380352570417271320999645871985714109730849227819705842774141121773250142388943847*x^3*y^13*z^8-42398320405404873224759676809640262072244683044104729720539880769228218074227899869095656478142*x^2*y^14*z^8+49836691052458431989595011244011662936079933785596933715735983494749695478332583122697955742163*x*y^15*z^8-23009968244075590563321829180489649678231224325348879758094535335851331780372717642918131125298*y^16*z^8-37813202640523734553802291061402290009825626855992672548562745811136923687241750132511866287347*x^3*y^12*z^9+97593719194162921036141148818271826417649895930246221489229611531955530120126573534941137277656*x^2*y^13*z^9-105177036624181685417002257717116882826230852662199079528718885187806931006719533923559528253653*x*y^14*z^9+37923329271284907951162301085449196664203470553815531295959802401754426667871702728015292069980*y^15*z^9+11893160018141514263566271675130258191616722924165588727150958419544692596080853214220467071145*x^3*y^11*z^10-76813117594905786576535720642934800404638188386246069071111102555324304478894993585938496219422*x^2*y^12*z^10+111418409611569541517346840276689469864575848018258761727898012571854201430669235219898794621488*x*y^13*z^10-55927506050136225132229306334474081172967896191153146970836991677643567427551722565624608106619*y^14*z^10-5711334525990266551802376450093917725342626897457852247063468765892033317490592721533190010505*x^3*y^10*z^11+25228706440015423371042225623051055577936854539923737341512215643618019357897216716279755761646*x^2*y^11*z^11-42649562710751832573619723851863167952449169570937706322824511339735509804298321001774164620320*x*y^12*z^11+26121591601395251037396162049498380926301953712284950458025643391918458683023175988991761998238*y^13*z^11+15723758223526402768235625098589575109124568761465128321468078560788901577410438487252119093938*x^3*y^9*z^12-40504855514240036005345746259159051312838688436910982691946687734618568034111370551646369546433*x^2*y^10*z^12+52410343920614320427726446835151686471835104665180663856737649690063903952832448876774771719644*x*y^11*z^12-20731006770491553538044927805459834583886082616990940476479310834401176102717221601975033717216*y^12*z^12-1492786052194790882332960047054131262288760274699368935942417970212977555536115957235308599878*x^3*y^8*z^13+26705663725156910527411829145242190869323409870358369923232107127980239240803032525049993634413*x^2*y^9*z^13-42308286844410870446568652984889991261746752041892019302032850518107983438905435629126259577133*x*y^10*z^13+22170976318572318580017200644861989370236448400826070873801631886746677840659547785352328816906*y^11*z^13+162156792518543842978834194377438886887980641176265611686347683795852354530601696782437780528*x^3*y^7*z^14+6965565597789839193609081334883124776214222804490937796923341643729058007963219769715989395676*x^2*y^8*z^14-8963227133993917088785907551033796120420018083709689610972115373940987508072789562208955532368*x*y^9*z^14+3320673871766492843868332151516466055484638949121316634807763363215456506074469427936724824175*y^10*z^14-3675900490495037055067132202722056886983189620323712944152964286419625669722420711152989208856*x^3*y^6*z^15+11933146237152900983641650877646229326099195829680710853314549888014043101415150145349127682192*x^2*y^7*z^15-14486865228620916575562728731166854419425397803314538485767124540551066076770661633604267378926*x*y^8*z^15+4628227504296468245810626708036863555610126842669422999829495584223896589367014986672924126661*y^9*z^15+2984134559055170080889361777998797007996815203249166167927279001388559183268137082080809065831*x^3*y^5*z^16-6276555885700278528545100524891431717669760316949160613173835021699020587117354855281792443343*x^2*y^6*z^16+2851610373501875962318737252824814021854625174857660252795312556688241777225202510721183774677*x*y^7*z^16+472319205944167594613117601778869479644891727435144894124348078603257711355884407658965760148*y^8*z^16+2056526583501247876684970132828855869162962124517290774782137463542088969695423857624322003921*x^3*y^4*z^17-3364897745337235696904807997611080015149135660053267500793022038737925150578382987288913021763*x^2*y^5*z^17+3343725858428443789269723975709076195716635886422445232772834388180785313265461427128857304890*x*y^6*z^17-1274327010084243940733002674289414986869108746214641788568434573688882456218022061378039976918*y^7*z^17+2688574650856418525553270199783966271801514230828921607938233902294637886415954121877431534424*x^3*y^3*z^18-4258632369376828372825648334804259075299730476732315274475855571909326717993103488423310960344*x^2*y^4*z^18+1365053486793082801179667728655542540737193419204911807565348741667010907220816166519641566458*x*y^5*z^18+792304671564769281011603070121245469097756691170090984821821864175761072070674995260940188011*y^6*z^18-458152583650618410417133111664558534915492389230433423813799160388119233205794078626103360824*x^3*y^2*z^19+1078751674902258783536622646021431283446692573008550017782897593399223115919232081781149316232*x^2*y^3*z^19-491718349212413077766307334445700016484376429234156325399991525891694159256346335900377448361*x*y^4*z^19-395926119513564836662087178904498817541389326806381460990297303256542469738443581941302954210*y^5*z^19-357458739290344362819319077412880029989798536219515804665409926421594398726409847202770760848*x^3*y*z^20-111343083363465545941822305193737955329464288090033351680113362345122126309461365472459843312*x^2*y^2*z^20-241552667705985438153576916031344372043452673508807188896265998880429811827808251616437362496*x*y^3*z^20+148831716415169966707373876394171635620491634803178313727797809802140816118648040629164631272*y^4*z^20-638556858800417611263960356220739957730963510017063829739102516887149227469904687978977004592*x^3*z^21+424560051017991449906697729304881268658499802478266900064142347787953993153383159046134210320*x^2*y*z^21+525263427422351210338231761942297287295705392296581457574151790583857224005889184191820398456*x*y^2*z^21-544940883393335588423510955721101314791582647386378032228555813826365821507321093744455045104*y^3*z^21-322293628398357228515858658214959772311097270231005132369618994302536208813192140222488772096*x^2*z^22+499028494463884647952955037998862152183487083316438534391975953221938707098046117977605005536*x*y*z^22-149068954514367558115776317104168641816756493666412374970220985159567893363069628121913539568*y^2*z^22+218003208854097688606530857420741784872850763661291714430031398288394245775064833827071853232*x*z^23-145332457742708955623835442329133702831677696417919812052563274581584811761176035051381235488*y*z^23+1354285748024615047305507547568811052758459799633990496188625749637128906250000000000000*z^24);
//   Coordinate number 1:
map_0_coord_1 := 1*(-39932178842794966822071715660157332133835249993623587987217393151353730355495605468750*x^3*y^21+49714209020316602056188197064237173356368295032910072371580691157349086716245117187500*x^2*y^22-47346761544193972801308995091227221459432144192317760475482000052842162061966552734375*x*y^23+2502106708351139155461832886137516898423857207338002467322072342287044525146484375*y^24+507328764075874618985074820816947617742018903769600437240776143058754191431823730468750*x^3*y^20*z-1048544576854684605747845031420655455391508645924082180148729357014775399878259277343750*x^2*y^21*z+714059217476301045109932592925373405009286729532254164326633617601722830035700683593750*x*y^22*z-118144662740879780168239410688182951234170343057568602265415552497035018125268554687500*y^23*z+2467105781149824558112045803033582633344210272419219703330791269509858588304023437500000*x^3*y^19*z^2-2816830023073640817889987133438452001415789850747253854455316731350791131896649169921875*x^2*y^20*z^2+602614133233900433599017551481831136702351208888636712167850802134661061339700927734375*x*y^21*z^2+898947841926764124804045546566545148295995915878383652400972274823867955298310546875000*y^22*z^2-11080228002817648437509636131760985747026318860738511620835052257291571367119486083984375*x^3*y^18*z^3+28881127250330934868805863237745819615518529557346049340352552436196980169864481201171875*x^2*y^19*z^3-26523648382187305787018547323155572449317443832321807627685518120313678541655294189453125*x*y^20*z^3+6670980833322809228883544333611081765017317704350079602311867958798320218799262695312500*y^21*z^3-86941917918860321469041805246273550189319280464093761301045664064117512184231593017578125*x^3*y^17*z^4+142897925480015021191977941467968367565115161999712918390178576545211115146123682861328125*x^2*y^18*z^4-84613617245398042643159811948384013756619390031280392103206068154037031392818823242187500*x*y^19*z^4-9375341653968979334522193655476982951329986435083109829924238919537259150641551513671875*y^20*z^4-142012557391576809119454848940405986698099785115411744626207784560683598178419252929687500*x^3*y^16*z^5+60879910803743829831135506361162063337362180421010729037761822973099829009187569580078125*x^2*y^17*z^5+127518422504515045641233440422691389600357823550683017610350898353023408705394866943359375*x*y^18*z^5-160081025449885267935627420811783757952337278750095104617271478139111058030795206298828125*y^19*z^5+366868620203445768792201015518139602978323325781552955497515512135733500047054768066406250*x^3*y^15*z^6-1167440977684501886669475486931846910507469281516138746961144307782794167793465455322265625*x^2*y^16*z^6+1251189233367923230738737454212557813853305944709648400720676557081213897292023400878906250*x*y^17*z^6-459709077304871435926942317158197217152167411026066014327230038538402086030770856933593750*y^18*z^6+2172329806887434215214118020127973828719606784983477810293382899692623344602262990722656250*x^3*y^14*z^7-3945557188819267396241999996817074231143481585913932834378809472224994773550571553955078125*x^2*y^15*z^7+2825898701638299381982277411536653675417656311221830573739709870673034654328995202636718750*x*y^16*z^7-206531922376538368673346946985705896743242580787040687014612466555797754255169124755859375*y^17*z^7+4625079470688094659088438520228683251719757949956002371319519129202893029040209770507812500*x^3*y^13*z^8-5234161852467213847074660574865636925532445464083256124835827579197033462831947703857421875*x^2*y^14*z^8+1207305362341637149140442534315204704832421122907591900512600210887219493873541088867187500*x*y^15*z^8+2157179266615493038356513072199282548986283818221276530171641051011139866505657178955078125*y^16*z^8+4342050350250284946081567537022106185085065838734720114350756196130908584708925943603515625*x^3*y^12*z^9+1500659022214008889433141980191127242513181350865788214738469289724603083213183211669921875*x^2*y^13*z^9-8625134628227132901978125740763336543451457254198964532897696256336423818311115991210937500*x*y^14*z^9+7217978999961375040356521886402653787363300287112431618383853601945338835964170333251953125*y^15*z^9-2872256010400121100057810413475875373668997112657265091448717837699943520283262019042968750*x^3*y^11*z^10+19403166607822316443860238111138793701150486488913426934095246287130930701168077767333984375*x^2*y^12*z^10-25550146194503556642965419055865321935330940542996106567825339019313039320527638364257812500*x*y^13*z^10+11850799368116602467563338682205838136751213415947382242935710617382915732302270872802734375*y^14*z^10-16933403704144281201778270439624614766165082919078920688376907474321053903192883994140625000*x^3*y^10*z^11+40136030277430177516468312069087232641813611188863658111295211363736037416162621042480468750*x^2*y^11*z^11-37213366128844952164706626025438522992647563225856124980174625015262408640811234190673828125*x*y^12*z^11+9822738632086127265561598656788134597224383379690642395257669569112902186776385928955078125*y^13*z^11-30809771609926414171214200843189047355436798650790410186829249958175155628690360803222656250*x^3*y^9*z^12+46795146024591201739178309362142065048830469643242381985771854648516289539615419172363281250*x^2*y^10*z^12-27772228442356856450837236904981130781064133197056092188091799762496201947649310659179687500*x*y^11*z^12-2618558142633825248593190526104905704547576410550023719447846465629916066039322354736328125*y^12*z^12-35325194437613359517543736279569475614184432520905616714731421351204891895895430712890625000*x^3*y^8*z^13+29291039426324970503356292158645010877933008129924652676483809946542708396426359375000000000*x^2*y^9*z^13+5755904482618335592806415718689935244192947700685583921330286000288723249481082468261718750*x*y^10*z^13-21568431923460645447837861833459915752394432966647621195662415857017955894718197756347656250*y^11*z^13-27443781164180685372971139359110765241003732070959577862423614283940734290026268249511718750*x^3*y^7*z^14-3973179115589425106263762913949060297176433375500409059455081435528843653093294622802734375*x^2*y^8*z^14+46842026989752628716250371126700105044345275685519456375944408567888551105441476092529296875*x*y^9*z^14-37177196664130330068636999037520125816808062844185681610644423735534762956705777459716796875*y^10*z^14-12697637757968245729583405900952251551461423360969051495300219442947123609436518497314453125*x^3*y^6*z^15-32694658178943188622422645619881288850521376224321255930214571103349319011561725229492187500*x^2*y^7*z^15+72031979545119513739253918262556297777479185972363755592002698401974699093457905802001953125*x*y^8*z^15-41287011047777267888850200387602650209045323803256789570955446747864779524263055676269531250*y^9*z^15+187139794577508271990180225748578548895895363782169601741380825125867488378594512939453125*x^3*y^5*z^16-42307780272920249850307265783891210467265470306675733271412344212858301810951372985839843750*x^2*y^6*z^16+70129626738908476001916300410409639275743870341389693448105046880484798536137463939208984375*x*y^7*z^16-33597388438263646511738788182103835906256467197346930830016665254930039052654380291748046875*y^8*z^16+5976644139244360383337783615496929953844565214130283818857686611551229984850909086914062500*x^3*y^4*z^17-33831077639014873936885184502959238443669424946358863259202795920043398179671511303710937500*x^2*y^5*z^17+48787760632798752523367310120025022000304662948466770861226592565814453183398956905517578125*x*y^6*z^17-20637471429359880209342569708065955889408605751524813506457909501862244383773833027343750000*y^7*z^17+5412631757365753214427913398662779843815219107666292244991846831508443307847209433593750000*x^3*y^3*z^18-18707321187490280434735802962884172739012485327231569387804361781402992765697604038085937500*x^2*y^4*z^18+24494792153534239507764766236476191195065460245357232868518999281683672345906203145751953125*x*y^5*z^18-9470644728844717579889032797036115753867606442651375237811645776423838251105528040771484375*y^6*z^18+2626576391614924052251839809055657927508264510520652796201469640219524072765471754150390625*x^3*y^2*z^19-7117816877546939408178828842222163374129259176195130753410774657858380342319038459472656250*x^2*y^3*z^19+8468251390269066059477885107409864838188460964314441776938605849415242197699116839599609375*x*y^4*z^19-3053940019666279662109196884023502606951274765244806276086863769338068135366539472656250000*y^5*z^19+712626054233317486225960422216963730361687590318903013189517783108097014517083536376953125*x^3*y*z^20-1747071631305120483601000087730550708178416185400765982172241813440387733195142866210937500*x^2*y^2*z^20+1744264037966154160533384320504256539406297651766855529232651113764050571909215953369140625*x*y^3*z^20-555262360513242022793499153828318836143677109610790047999037802626914171391844832763671875*y^4*z^20+85287725932785559431743304920437031198607930608136489854845457073147322195779899902343750*x^3*z^21-237554591788317402343242455708487015603283843068705196979952295357452649593774785156250000*x^2*y*z^21+94613565817529358313571065735976182405959186013332334636594889766539180889619637451171875*x*y^2*z^21+14112619436883519598361455337844648644486069135209722454296258584026379516462055664062500*y^3*z^21-11621889827599789909437171177418068669740306319526092830898499857536168189904727783203125*x^2*z^22-43309814463561037975556803575828905946625668520202317432003948956974658400328691406250000*x*y*z^22+32531865115023958982799562156426899468766358667983462973302652796335947728235454101562500*y^2*z^22-8118772551384776893865800058619151864334852637643338988893507670400505253571623535156250*x*z^23+5412827921340368238214401245431608090178149376036754574665477048503911373004353027343750*y*z^23-13423030102485044072742100376880678287480098312875533384479874036543769836425781250*z^24);

P2<x,y,z>:=ProjectiveSpace(Rationals(),2);
model_0 := [5*x^4-7*x^3*y+3*x^2*y^2+2*x*y^3+8*x^3*z-7*x^2*y*z-2*x*y^2*z+5*y^3*z+4*x^2*z^2-5*x*y*z^2+y^2*z^2-3*x*z^3+2*y*z^3];

C:=Curve(P2,model_0);
P1<r1, r2> := ProjectiveSpace(Rationals(),1);
j:= map<C -> P1 | [map_0_coord_0,map_0_coord_1]>;

cubic_cm:= [4,23,31,44,59,76,83,92,107,108,124,139,172,211,243,268,283,307,331,379,499,547,643,652,883,907];
discs:=[33245, 19395655478420];
p0:=C![1,-2,1];
p1:=C![0,1,0];
p2:=C![0,0,1];
p3:=C![-1,-1,1];
R<t>:=PolynomialRing(Rationals());
print jp0;
print jp1;
print jp2;
print jp3;
        
function applyf(Dlist,Dfeqns, myC)
    F<z,w> := FunctionField(myC);

    divD := Parent(Divisor(w))!0;
    for pt in Dlist do
        P := pt[2];
   Ã¥     n := pt[1];
        evalP := [];
        for fn in Dfeqns do
            S<v,y,u,x>:=Parent(fn);
            Append(~evalP, Evaluate(fn, [v, P[2]/P[3], u, P[1]/P[3]]));
        end for;
        evalP := GroebnerBasis(evalP);
        newgb:=[];
        for i in [1 .. #evalP] do
            Append(~newgb, Evaluate(evalP[i],[w,0,z,0]));
        end for;
        divP := GCD(Divisor(newgb[1]),Divisor(newgb[2]));
        if n gt 0 then
            for i in [1 .. n] do
                divD := divD + divP;
            end for;
        elif n lt 0 then
            for i in [1 .. -n] do
                divD := divD - divP;
            end for;
        end if;
  end for;

  return divD;

end function;

P<x,y,z>:= Ambient(C);
C := PlaneCurve(Equation(C));
Cprime := PlaneCurve(newf);
newf := Evaluate(f, [x, y, x+y+z]);
m := map<Cprime->C| [x,y,x+y+z]>;
assert IsIsomorphism(m);
p0 :=  C!Eltseq(p0);
p1:=  C!Eltseq(p1);
p2:=  C!Eltseq(p2);
p3:=  C!Eltseq(p3);
p0prime := (m^(-1))(p0);
p1prime := (m^(-1))(p1);
p2prime := (m^(-1))(p2);
p3prime := (m^(-1))(p3);

/*The commented out part of this code uses the Endomorphisms package to generate the correspondence for the matrix M
The package is available here https://github.com/edgarcosta/endomorphisms or in CHIMP https://github.com/edgarcosta/CHIMP
Alternatively, one can run the pre-computed correspondence to verify that the rest of the computations run correctly.
This is what the un-commented code does */
//M := Matrix(Rationals(),[[ 3, 0,  1], [ 2,  0 ,1],[ -5, 1,  -2]]);
//_, corr := DivisorFromMatrixAmbientSplit(Cprime, p0prime, Cprime, p0prime, M);
//listofeq :=Equations(corr);
//S<v,y,u,x>:=Parent(listofeq[1]);
//newfs := [S!f : f in listofeq ];

corr := Read("correspondence.txt");
S<v,y,u,x>:=PolynomialRing(Rationals(),4);
corr_eqns := eval corr;

//These computations take a few minutes each
alphap0 := applyf([[*1,p0prime*]], corr_eqns, Cprime);
alphap1 := applyf([[*1,p1prime*]], corr_eqns, Cprime);
alphap2 := applyf([[*1,p2prime*]], corr_eqns, Cprime);
alphap3 := applyf([[*1,p3prime*]], corr_eqns, Cprime);

//Take the non infinite parts of each one
alphap0 := 3*Divisor(Support(alphap0)[1]);
alphap1 :=  Divisor(Support(alphap1)[1]);;
alphap2 :=  Divisor(Support(alphap2)[1]);;
alphap3 :=  Divisor(Support(alphap3)[1]);;


e3 := Divisor(Place(p3prime)) - Divisor(Place(p0prime));

e2 := Divisor(Place(p2prime)) - Divisor(Place(p0prime));

e1 := Divisor(Place(p1prime)) - Divisor(Place(p0prime));

alphae1 := alphap1 - alphap0;
alphae2 := alphap2 - alphap0;
alphae3 := alphap3 - alphap0;

function find_lin_equiv(D, elist : bd := 2)
    for A in [-bd..bd] do
        for B in [-bd..bd] do 
            for C in [-bd..bd] do
                if IsLinearlyEquivalent(D, A*elist[1] + B*elist[2]+C*elist[3]) then
                    return [A, B, C];
                end if;
            end for;
        end for;
    end for;
end function;

r1 := find_lin_equiv(alphae1, [e1,e2,e3]);
r2 := find_lin_equiv(alphae2, [e1,e2,e3]);
r3 := find_lin_equiv(alphae3, [e1,e2,e3]);

R := Transpose(Matrix([r1,r2,r3]));
print MinimalPolynomial(R); //double check this for sanity

3*Transpose(R)[1] - Transpose(R^2)[1] -Vector([1,0,0]) eq Transpose(R)[2];

//verifies that (-R^2 +3R+I)(e1) = e2

